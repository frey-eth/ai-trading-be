<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EVM Wallet Login - Client Example</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
      }
      .step {
        margin: 20px 0;
        padding: 15px;
        background: #f9f9f9;
        border-left: 4px solid #4caf50;
        border-radius: 4px;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px 5px;
      }
      button:hover {
        background: #45a049;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .info {
        background: #e3f2fd;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
        word-break: break-all;
      }
      .error {
        background: #ffebee;
        color: #c62828;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .success {
        background: #e8f5e9;
        color: #2e7d32;
        padding: 15px;
        border-radius: 5px;
        margin: 10px 0;
      }
      code {
        background: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: monospace;
      }
      input {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê EVM Wallet Login - Client Example</h1>
      <p>
        V√≠ d·ª• n√†y minh h·ªça c√°ch client sign message v√† g·ª≠i l√™n server ƒë·ªÉ verify.
      </p>

      <div class="step">
        <h3>B∆∞·ªõc 1: K·∫øt n·ªëi Wallet</h3>
        <div id="metamaskStatus" style="margin: 10px 0"></div>
        <button id="connectBtn" onclick="connectWallet()">
          Connect Wallet (MetaMask)
        </button>
        <div id="walletInfo" class="info" style="display: none">
          <strong>Connected Wallet:</strong> <span id="walletAddress"></span>
        </div>
      </div>

      <div class="step">
        <h3>B∆∞·ªõc 2: Request Nonce t·ª´ Server</h3>
        <label>API Base URL:</label>
        <input
          type="text"
          id="apiUrl"
          value="http://localhost:3000"
          placeholder="http://localhost:3000"
        />
        <button id="getNonceBtn" onclick="getNonce()" disabled>
          Get Nonce from Server
        </button>
        <div id="nonceInfo" class="info" style="display: none">
          <strong>Nonce:</strong> <span id="nonceValue"></span><br />
          <strong>Message to Sign:</strong> <span id="messageValue"></span>
        </div>
      </div>

      <div class="step">
        <h3>B∆∞·ªõc 3: Sign Message v·ªõi Wallet</h3>
        <p>
          <strong>L∆∞u √Ω:</strong> Ch·ªâ client m·ªõi c√≥ th·ªÉ sign. Server s·∫Ω verify
          signature.
        </p>
        <button id="signBtn" onclick="signMessage()" disabled>
          Sign Message
        </button>
        <div id="signatureInfo" class="info" style="display: none">
          <strong>Signature:</strong> <span id="signatureValue"></span>
        </div>
      </div>

      <div class="step">
        <h3>B∆∞·ªõc 4: G·ª≠i Signature l√™n Server ƒë·ªÉ Verify</h3>
        <p>
          <strong>L∆∞u √Ω:</strong> Ch·ªâ server m·ªõi verify ƒë∆∞·ª£c. Client kh√¥ng
          verify.
        </p>
        <button id="loginBtn" onclick="login()" disabled>
          Login (Server will verify)
        </button>
        <div id="loginResult"></div>
      </div>

      <div class="step">
        <h3>üìã Flow Summary</h3>
        <ol>
          <li><strong>Client:</strong> Request nonce t·ª´ server</li>
          <li><strong>Client:</strong> Sign message v·ªõi wallet (MetaMask)</li>
          <li><strong>Client:</strong> G·ª≠i signature + message l√™n server</li>
          <li>
            <strong>Server:</strong> Verify signature (recover address t·ª´
            signature)
          </li>
          <li>
            <strong>Server:</strong> So s√°nh recovered address v·ªõi wallet
            address
          </li>
          <li>
            <strong>Server:</strong> Tr·∫£ v·ªÅ user data n·∫øu verify th√†nh c√¥ng
          </li>
        </ol>
      </div>
    </div>

    <script>
      let connectedWallet = null;
      let currentNonce = null;
      let currentMessage = null;
      let currentSignature = null;

      // Check MetaMask status
      function checkMetaMask() {
        const statusDiv = document.getElementById('metamaskStatus');

        // Check for MetaMask
        if (typeof window.ethereum !== 'undefined') {
          // Check if it's MetaMask specifically
          const isMetaMask =
            window.ethereum.isMetaMask ||
            (window.ethereum.providers &&
              window.ethereum.providers.find((p) => p.isMetaMask));

          if (isMetaMask || window.ethereum.isMetaMask) {
            statusDiv.innerHTML =
              '<div class="success">‚úÖ MetaMask detected!</div>';
            return true;
          } else {
            statusDiv.innerHTML =
              '<div class="info">‚ö†Ô∏è Ethereum provider detected (may not be MetaMask)</div>';
            return true;
          }
        } else {
          statusDiv.innerHTML =
            '<div class="error">‚ùå MetaMask not detected! Please install MetaMask extension.</div>';
          return false;
        }
      }

      // B∆∞·ªõc 1: Connect Wallet
      async function connectWallet() {
        const statusDiv = document.getElementById('metamaskStatus');
        const connectBtn = document.getElementById('connectBtn');

        try {
          // Check MetaMask first
          if (typeof window.ethereum === 'undefined') {
            statusDiv.innerHTML =
              '<div class="error">‚ùå MetaMask ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t! Vui l√≤ng c√†i MetaMask extension t·ª´ <a href="https://metamask.io" target="_blank">metamask.io</a></div>';
            return;
          }

          connectBtn.disabled = true;
          connectBtn.textContent = 'Connecting...';

          // Try to get provider - handle both old and new MetaMask
          let provider = window.ethereum;

          // If MetaMask v10+ with providers array
          if (
            window.ethereum.providers &&
            Array.isArray(window.ethereum.providers)
          ) {
            provider =
              window.ethereum.providers.find((p) => p.isMetaMask) ||
              window.ethereum.providers[0];
          }

          console.log('üîç Detected provider:', provider);
          console.log('üîç Is MetaMask:', provider.isMetaMask);

          // Request account access
          const accounts = await provider.request({
            method: 'eth_requestAccounts',
          });

          if (!accounts || accounts.length === 0) {
            throw new Error('No accounts found. Please unlock MetaMask.');
          }

          connectedWallet = accounts[0];
          document.getElementById('walletAddress').textContent =
            connectedWallet;
          document.getElementById('walletInfo').style.display = 'block';
          document.getElementById('getNonceBtn').disabled = false;
          statusDiv.innerHTML =
            '<div class="success">‚úÖ Wallet connected successfully!</div>';

          console.log('‚úÖ Connected wallet:', connectedWallet);
        } catch (error) {
          console.error('‚ùå Error connecting wallet:', error);

          let errorMessage = 'L·ªói k·∫øt n·ªëi wallet: ';
          if (error.code === 4001) {
            errorMessage =
              'User ƒë√£ t·ª´ ch·ªëi k·∫øt n·ªëi. Vui l√≤ng approve trong MetaMask.';
          } else if (error.code === -32002) {
            errorMessage =
              'Request ƒëang pending. Vui l√≤ng m·ªü MetaMask v√† approve.';
          } else {
            errorMessage += error.message;
          }

          statusDiv.innerHTML = `<div class="error">‚ùå ${errorMessage}</div>`;
          alert(errorMessage);
        } finally {
          connectBtn.disabled = false;
          connectBtn.textContent = 'Connect Wallet (MetaMask)';
        }
      }

      // B∆∞·ªõc 2: Get Nonce t·ª´ Server
      async function getNonce() {
        if (!connectedWallet) {
          alert('Vui l√≤ng connect wallet tr∆∞·ªõc!');
          return;
        }

        const apiUrl = document.getElementById('apiUrl').value;
        const getNonceBtn = document.getElementById('getNonceBtn');
        getNonceBtn.disabled = true;
        getNonceBtn.textContent = 'Loading...';

        try {
          const response = await fetch(
            `${apiUrl}/auth/nonce?walletAddress=${connectedWallet}`,
          );

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          currentNonce = data.nonce;
          currentMessage = data.message;

          document.getElementById('nonceValue').textContent = currentNonce;
          document.getElementById('messageValue').textContent = currentMessage;
          document.getElementById('nonceInfo').style.display = 'block';
          document.getElementById('signBtn').disabled = false;

          console.log('‚úÖ Nonce received:', currentNonce);
          console.log('‚úÖ Message to sign:', currentMessage);
        } catch (error) {
          console.error('‚ùå Error getting nonce:', error);
          document.getElementById('loginResult').innerHTML =
            `<div class="error">L·ªói: ${error.message}<br>ƒê·∫£m b·∫£o server ƒëang ch·∫°y t·∫°i ${apiUrl}</div>`;
        } finally {
          getNonceBtn.disabled = false;
          getNonceBtn.textContent = 'Get Nonce from Server';
        }
      }

      // B∆∞·ªõc 3: Sign Message v·ªõi Wallet
      async function signMessage() {
        if (!currentMessage) {
          alert('Vui l√≤ng get nonce tr∆∞·ªõc!');
          return;
        }

        if (typeof window.ethereum === 'undefined') {
          alert('MetaMask ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t!');
          return;
        }

        const signBtn = document.getElementById('signBtn');
        signBtn.disabled = true;
        signBtn.textContent = 'Signing...';

        try {
          // Get provider - handle both old and new MetaMask
          let ethereumProvider = window.ethereum;
          if (
            window.ethereum.providers &&
            Array.isArray(window.ethereum.providers)
          ) {
            ethereumProvider =
              window.ethereum.providers.find((p) => p.isMetaMask) ||
              window.ethereum.providers[0];
          }

          // S·ª≠ d·ª•ng ethers.js ƒë·ªÉ sign message
          const provider = new ethers.providers.Web3Provider(ethereumProvider);

          // Request accounts to ensure we have access
          await provider.send('eth_requestAccounts', []);

          const signer = provider.getSigner();
          const signerAddress = await signer.getAddress();

          console.log('üìù Signing message with address:', signerAddress);
          console.log('üìù Message:', currentMessage);

          // Sign message - CH·ªà CLIENT M·ªöI L√ÄM ƒê∆Ø·ª¢C
          currentSignature = await signer.signMessage(currentMessage);

          document.getElementById('signatureValue').textContent =
            currentSignature;
          document.getElementById('signatureInfo').style.display = 'block';
          document.getElementById('loginBtn').disabled = false;

          console.log('‚úÖ Message signed:', currentSignature);
          console.log('üìù Note: Ch·ªâ server m·ªõi c√≥ th·ªÉ verify signature n√†y!');
        } catch (error) {
          console.error('‚ùå Error signing message:', error);
          let errorMessage = 'L·ªói khi sign: ';
          if (error.code === 4001) {
            errorMessage =
              'User ƒë√£ t·ª´ ch·ªëi sign message. Vui l√≤ng approve trong MetaMask.';
          } else if (error.code === -32002) {
            errorMessage =
              'Request ƒëang pending. Vui l√≤ng m·ªü MetaMask v√† approve.';
          } else {
            errorMessage += error.message;
          }
          alert(errorMessage);
        } finally {
          signBtn.disabled = false;
          signBtn.textContent = 'Sign Message';
        }
      }

      // B∆∞·ªõc 4: Login - Server s·∫Ω verify
      async function login() {
        if (!currentSignature || !currentMessage) {
          alert('Vui l√≤ng sign message tr∆∞·ªõc!');
          return;
        }

        const apiUrl = document.getElementById('apiUrl').value;
        const loginBtn = document.getElementById('loginBtn');
        loginBtn.disabled = true;
        loginBtn.textContent = 'Logging in...';

        try {
          // G·ª≠i signature l√™n server - SERVER S·∫º VERIFY
          const response = await fetch(`${apiUrl}/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              walletAddress: connectedWallet,
              signature: currentSignature,
              message: currentMessage,
              region: 'us',
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Login failed');
          }

          document.getElementById('loginResult').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Login th√†nh c√¥ng!</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <p><strong>L∆∞u √Ω:</strong> Server ƒë√£ verify signature v√† x√°c nh·∫≠n b·∫°n s·ªü h·ªØu wallet n√†y.</p>
                    </div>
                `;

          console.log('‚úÖ Login successful:', data);
        } catch (error) {
          console.error('‚ùå Error logging in:', error);
          document.getElementById('loginResult').innerHTML =
            `<div class="error">L·ªói login: ${error.message}</div>`;
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Login (Server will verify)';
        }
      }

      // Check MetaMask on page load
      window.addEventListener('load', () => {
        checkMetaMask();

        // Auto-connect n·∫øu ƒë√£ connected tr∆∞·ªõc ƒë√≥
        if (typeof window.ethereum !== 'undefined') {
          let provider = window.ethereum;
          if (
            window.ethereum.providers &&
            Array.isArray(window.ethereum.providers)
          ) {
            provider =
              window.ethereum.providers.find((p) => p.isMetaMask) ||
              window.ethereum.providers[0];
          }

          provider
            .request({ method: 'eth_accounts' })
            .then((accounts) => {
              if (accounts && accounts.length > 0) {
                connectedWallet = accounts[0];
                document.getElementById('walletAddress').textContent =
                  connectedWallet;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('getNonceBtn').disabled = false;
                console.log('‚úÖ Auto-connected to:', connectedWallet);
              }
            })
            .catch((error) => {
              console.error('Error checking accounts:', error);
            });
        }
      });

      // Listen for account changes
      if (typeof window.ethereum !== 'undefined') {
        let provider = window.ethereum;
        if (
          window.ethereum.providers &&
          Array.isArray(window.ethereum.providers)
        ) {
          provider =
            window.ethereum.providers.find((p) => p.isMetaMask) ||
            window.ethereum.providers[0];
        }

        provider.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            connectedWallet = null;
            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('getNonceBtn').disabled = true;
            console.log('üîå Wallet disconnected');
          } else {
            connectedWallet = accounts[0];
            document.getElementById('walletAddress').textContent =
              connectedWallet;
            document.getElementById('walletInfo').style.display = 'block';
            document.getElementById('getNonceBtn').disabled = false;
            console.log('üîÑ Wallet changed to:', connectedWallet);
          }
        });

        provider.on('chainChanged', () => {
          window.location.reload();
        });
      }
    </script>
  </body>
</html>
